#!/usr/bin/env bash

set -e

git --version

# Prompt immediately for sudo, and keep it alive while the install script runs
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

if hash brew 2>/dev/null; then
    echo "Homebrew already installed."
else
    echo "Installing Homebrew..."
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

if hash jq 2>/dev/null; then
    echo "jq already installed."
else
    echo "Installing jq..."
    brew install jq
fi

if hash mas 2>/dev/null; then
    echo "mas already installed."
else
    echo "Installing mas..."
    brew install mas
fi

if hash op 2>/dev/null; then
    echo "1Password CLI already installed."
else
    echo "Installing 1Password CLI..."
    brew cask install 1password-cli
fi

sudo spctl --add "$(which op)"

if [[ -z "$GITHUB_USER" ]]; then
    echo -n "GitHub user: "
    read GITHUB_USER
fi

if [[ -z "$GITHUB_USER" ]]; then
    echo "GITHUB_USER not defined."
    exit 1
fi

DOTFILES_PATH="$HOME/grit/github.com/$GITHUB_USER/dotfiles"

if [[ -d "$DOTFILES_PATH" ]]; then
    echo "Pulling $GITHUB_USER/dotfiles..."
    pushd "$DOTFILES_PATH" > /dev/null
    git pull
    popd > /dev/null
else
    echo "Cloning $GITHUB_USER/dotfiles..."
    git clone "https://github.com/$GITHUB_USER/dotfiles.git" "$DOTFILES_PATH"
fi

if [[ -e "$HOME/dotfiles" ]]; then
    echo "Dotfiles shortcut directory already exists."
else
    ln -s "$DOTFILES_PATH" "$HOME/dotfiles"
fi

# start using utility functions
source "$HOME/dotfiles/dotfiles/.functions.zsh"

if mas account; then
    echo "App store sign in detected."
else
    op get item "Apple ID" | jq -r '.details.fields[] | select (.designation == "password") | .value' | tr -d '\n' | pbcopy
    echo "Sign in to the app store first. Password has been copied to the clipboard."
    mas open
    open "x-apple.systempreferences:com.apple.preferences.AppleIDPrefPane"
    exit 1
fi

for FILE in "$HOME/dotfiles/setup/"*-*.bash; do
  source "$FILE"
done

echo "Done. System must be restarted for some changes to take effect."
