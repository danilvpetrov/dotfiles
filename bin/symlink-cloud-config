#!/usr/bin/env bash

set -e
set -x

CLOUD_PATH="$HOME/Google Drive"

CLOUD_BACKUP_PATH="$CLOUD_PATH/Backup"

if [[ -h "$HOME/.ssh/config" ]]; then
    echo "SSH config already linked."
else
    if [[ -f "$HOME/.ssh/config" ]]; then
        mv "$HOME/.ssh/config" "$HOME/.ssh/config.bak"
    fi

    echo "Linking SSH config..."
    ln -s "$CLOUD_BACKUP_PATH/.ssh/config" "$HOME/.ssh/config"
fi

VSCODE_USER_CONFIG_PATH="$HOME/Library/Application Support/Code/User"
CLOUD_VSCODE_USER_CONFIG_PATH="$CLOUD_BACKUP_PATH/VSCode"

echo "Install VSCode extensions..."
cat "$CLOUD_VSCODE_USER_CONFIG_PATH/extensions.txt"   | xargs -L 1 echo code --install-extension

echo "Linking VSCode settings..."
mv "$VSCODE_USER_CONFIG_PATH/settings.json" "$VSCODE_USER_CONFIG_PATH/settings.json.bak"
ln -s "$CLOUD_VSCODE_USER_CONFIG_PATH/settings.json" "$VSCODE_USER_CONFIG_PATH/settings.json"

echo "Linking VSCode snippets..."
for spath in "$CLOUD_VSCODE_USER_CONFIG_PATH/snippets/"*.json; do
    s=$(basename "$spath")
    if [[ -f "$VSCODE_USER_CONFIG_PATH/snippets/$s" ]]; then
        mv "$VSCODE_USER_CONFIG_PATH/snippets/$s" "$VSCODE_USER_CONFIG_PATH/snippets/$s.bak"
    fi
    ln -s "${spath}" "$VSCODE_USER_CONFIG_PATH/snippets/$s"
done

echo "Running additional scripts..."
for script in "$CLOUD_BACKUP_PATH/bin/"*.bash; do
    source "$script"
done
